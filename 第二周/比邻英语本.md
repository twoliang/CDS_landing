# 比邻英语本

## 微服务

**比邻英语本**是一个帮助用户学习英语单词的轻量级软件，它包含以下业务功能：

- 用户注册；
- 用户登录；
- 用户信息查询；
- 单词的增删改查。

我们将这些服务简单地拆分，将同类功能放在一起，演化出两个微服务：

- 用户服务：处理用户注册、登录、信息查询等功能；
- 单词服务：提供单词相关的功能，比如增删改查。

微服务不直接对外提供服务，而是统一交由网关处理。网关作为一个`Web`服务，它不直接提供具体的业务功能，而是负责接收请求，转发到各微服务，最后拼接数据返回，以此来完成业务功能。

网关的功能不仅限于协议转换，还包括负载均衡、认证授权、日志记录、监控和限流等。微服务之间通常使用`HTTP`或`gRPC`进行通讯。

本书微服务采用`gRPC`协议。

![img](D:\goPrepare\图文\gRPC.png)

## 代码仓库

微服务将单体服务拆开，代码也自然分离。它的代码仓库，有两种常见的管理方式：

- **Multirepo：** 多仓库模式，每个微服务都有独立的仓库。优点是每个仓库相对较小，易于管理。缺点是需要额外的工具，流程协调各个服务之间的依赖和版本。
- **Monorepo：** 单一仓库模式，所有微服务的代码都存放在一个仓库中。优点是可以统一管理版本和依赖，缺点是仓库可能会变得庞大，管理复杂度增加。

我们的项目采用`Monorepo`模式。`Multirepo`模式下一个服务一个目录，无需多言。

## protobuf

`Protobuf` 是 `Google` 设计的数据序列化格式，用于结构化数据的序列化和反序列化。使用 `.proto` 文件定义消息结构，然后通过编译器生成相应语言的代码。

## etcd

etcd 是一个高可用的键值存储系统，主要用于共享配置和服务发现，在分布式系统中应用广泛，以下是关于它的详细介绍：

**起源与发展**

- etcd 最初是由 CoreOS 公司开发的，于 2013 年开源，旨在为分布式系统提供一个可靠的、一致的配置管理和服务发现解决方案。
- 它受到了 Google 的 Chubby 和 Apache ZooKeeper 等分布式协调服务的启发，结合了这些系统的优点，并针对现代分布式应用的需求进行了优化。

**特点**

- **强一致性**：采用 Raft 一致性算法，确保在分布式环境中数据的强一致性，即所有节点都能看到相同的数据状态，这对于配置信息等关键数据的管理至关重要。
- **高可用性**：通常以集群方式部署，一般建议部署奇数个节点，如 3 个、5 个或 7 个节点等，可容忍部分节点故障，仍能保证整个系统的正常运行，提供持续的服务。
- **简单易用**：提供了简洁的 HTTP API，方便开发人员进行数据的读写操作，可轻松地与各种编程语言和框架集成。
- **安全可靠**：支持 SSL/TLS 加密通信，确保数据在传输过程中的安全性，同时还提供了身份验证和授权机制，以控制对数据的访问。
- **动态配置**：允许在运行时动态地更新配置信息，应用程序可以实时地获取最新的配置，无需重启，提高了系统的灵活性和可维护性。

**应用场景**

- **服务发现**：微服务架构中，etcd 可以用于服务实例的注册与发现。服务提供者将自己的地址和端口等信息注册到 etcd 中，服务消费者可以从 etcd 中获取可用的服务实例列表，实现服务的动态发现和负载均衡。
- **配置管理**：集中管理分布式系统中的配置信息，当配置发生变化时，etcd 可以及时通知相关的应用程序，确保所有节点都能使用最新的配置。
- **分布式锁**：在分布式系统中，多个节点可能需要竞争资源或执行互斥操作，etcd 可以提供分布式锁机制，保证在同一时间只有一个节点能够获得锁，从而避免数据冲突和不一致性。
- **集群管理**：用于管理集群中的节点成员关系，记录节点的状态信息，如节点是否在线、节点的角色等，帮助实现集群的自动扩展、故障转移等功能。

**工作原理**

- etcd 集群中的节点通过 Raft 协议进行通信和数据同步，Raft 协议将节点分为领导者（Leader）和追随者（Follower）两种角色。领导者负责处理客户端的写请求，并将数据复制到其他追随者节点。追随者节点主要负责接收领导者发送的数据，并进行持久化存储。当领导者节点出现故障时，集群会通过选举机制选出新的领导者，以保证系统的正常运行。

etcd 在分布式系统中扮演着重要的角色，为分布式应用的开发和运维提供了有力的支持，是构建大规模分布式系统不可或缺的工具之一。

## Monorepo

在`Monorepo`仓库模式下，根目录只提供对项目依赖管理，不存在`main.go`文件。

`app`目录保存微服务各自的代码文件，例如`app/user/main.go`，`app/word/main.go`。

## 生成pbentity模型

### 与 `gen dao` 的差别

- `gen dao` 生成的数据是`go`文件，主要在微服务内部使用，例如`ORM`操作；
- `gen pbentity`生成的数据是`proto`文件，主要用作`gRPC`微服务之间的通讯。

## 协议文件

协议文件指的是`*.proto`文件，`proto`是`gRPC`协议通讯的标准，可以类比为`json`和`HTTP`。但是千万不要理解`proto`就是`json`，他们还是有一定区别的：`proto`同时定义“接口”信息和响应参数，请求参数，而`json`就单纯的保存数据。

`proto`文件统一存放在`manifest/protobuf`下，和普通的`HTTP`服务一样，使用目录层级来管理接口版本。

